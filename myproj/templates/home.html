{% extends 'layout.html' %}

{% block title %}
    Home
{% endblock %}

{% block content %}
<div style="display: flex; flex-wrap: wrap; gap: 2rem; padding: 2rem;">
    <div style="flex: 1; min-width: 300px;">
        <h1 style="color: #f7b23a;">HomePage</h1>
        <p>View Blogs â¤ <a href="/blogs" style="font-weight: bold;">Blogs</a></p>
    </div>

    <div style="flex: 1.5; min-width: 400px; background-color: #1a1a1a; border: 2px solid #f7b23a; border-radius: 12px; padding: 1.5rem; box-shadow: 0 0 20px rgba(247,178,58,0.3);">
        <h2 style="margin-bottom: 1rem;">ğŸ“ BlogBot</h2>
        
        <div id="chat" style="background-color: #111; border-radius: 8px; padding: 1rem; max-height: 200px; overflow-y: auto; font-size: 1.2rem; border: 1px solid #333; margin-bottom: 1rem;"></div>
        
        <textarea id="userInput" placeholder="Ask me to write a blog..." style="width: 100%; height: 80px; padding: 0.5rem; font-size: 1rem; border-radius: 8px; border: 1px solid #f7b23a; background: #222; color: whitesmoke;"></textarea>
        
        <button id="generateBtn" onclick="sendMessage()" style="margin-top: 1rem; padding: 0.6rem 1.2rem; background-color: #f7b23a; color: black; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">âš¡ Generate Blog</button>

        <div id="loading" style="display: none; margin-top: 1rem; color: #f7b23a; font-weight: bold;">â³ Generating blog, please wait...</div>

        <div id="preview" style="margin-top: 1.5rem; display: none; background: #2c2c2c; padding: 1rem; border-radius: 8px; border: 1px solid #f7b23a;">
            <h3 style="color: #f7b23a;">Generated Blog</h3>
            <div id="blogContent" style="white-space: pre-line; font-size: 1.1rem; margin-bottom: 1rem;"></div>
            {% if user.is_authenticated %}
                <button onclick="postBlog()" style="padding: 0.6rem 1.2rem; background-color: #81dbb8; color: black; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">ğŸ“¤ Post this blog</button>
            {% else %}
                <p style="color: red;"><b>ğŸ”’ Please <a href="/accounts/login/">log in</a> to post the blog.</b></p>
            {% endif %} 
        </div>
    </div>
</div>

<script>
function sendMessage() {
    const input = document.getElementById("userInput").value.trim();
    if (!input) return;

    const chat = document.getElementById("chat");
    const button = document.getElementById("generateBtn");
    const loader = document.getElementById("loading");

    button.disabled = true;
    loader.style.display = "block";

    chat.innerHTML += `<div style="margin-bottom: 0.5rem;"><b>You:</b> ${input}</div>`;

    fetch("/generate-blog/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: input })
    })
    .then(res => res.json())
    .then(data => {
        loader.style.display = "none";
        button.disabled = false;
        if (data.title && data.body) {
            chat.innerHTML += `<div style="margin-bottom: 0.5rem;"><b>BlogBot:</b> Here's your blog ğŸ‘‡</div>`;
            document.getElementById("preview").style.display = "block";
            document.getElementById("blogContent").innerText = `${data.title}\n\n${data.body}`;
            sessionStorage.setItem("blogTitle", data.title);
            sessionStorage.setItem("blogBody", data.body);
        } else {
            chat.innerHTML += `<div style="color: red;">âš ï¸ Failed to generate blog.</div>`;
        }
    })
    .catch(() => {
        loader.style.display = "none";
        button.disabled = false;
        chat.innerHTML += `<div style="color: red;">âŒ Error connecting to server.</div>`;
    });
}

function postBlog() {
    fetch("/post-blog/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            title: sessionStorage.getItem("blogTitle"),
            body: sessionStorage.getItem("blogBody")
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert("âœ… Blog posted successfully!");
        } else {
            alert("âš ï¸ Failed to post blog: " + (data.error || "Unknown error"));
        }
    })
    .catch(() => {
        alert("âŒ Network or server error while posting blog.");
    });
}
</script>

{% endblock %}
